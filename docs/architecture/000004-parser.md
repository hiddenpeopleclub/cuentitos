# Parser

### Submitters

- Fran Tufro

## Change Log

- 2025-01-20 - [First Draft of ADR created](https://github.com/hiddenpeopleclub/cuentitos/pull/52).

## Context

Cuentitos needs a fast and efficient parser to define the language grammar and
generate the necessary structures to be executed at runtime.

In version 0.2 we used PEST, a parser generator for Rust that allowed us to
define the language grammar and generate a parser that was responsible for
transforming the source code into a data structure that we could easily translate
into Rust code.

The main problem with PEST is that it was not easy to modify and extend the
language grammar, and it was not easy to maintain.

Thinking about the possibility of extending the language in the future through
plugins, it is necessary that the parser be easy to extend and maintain.

## Proposed Design

I will start by implementing a very simple parser: it will go line by line
through the script, and asking a list of possible classes if they can parse the
line. If a class can parse the line, the class is responsible for parsing it and
returning an object that represents the line.

### Block Parser Architecture (Updated 2025-03-06)

The parser has been implemented with an extensible block parser system:

1. **Line Parser Module** (`parser/src/line_parser.rs`)
   - Parses raw text lines to extract indentation level and content
   - Validates indentation (must be multiples of 2 spaces)
   - Returns `ParseResult` with trimmed string and indentation level

2. **Block Parser System** (`parser/src/block_parsers/`)
   - Each block type has its own parser module (e.g., `SectionParser`, `StringParser`)
   - Parsers implement a standard interface: `parse(line, level) -> Option<(Vec<Block>, Vec<String>)>`
   - Parser tries each block parser in order until one succeeds
   - Easy to extend by adding new block parsers

3. **Hierarchy Management**
   - Dual-stack approach for tracking hierarchy:
     - `last_block_at_level`: General content hierarchy
     - `last_section_at_level`: Section-specific hierarchy
   - Parent-child relationships established based on indentation levels
   - Sections use their own stack to maintain proper nesting

## Decision

Implemented the line-by-line parser with pluggable block parsers. This design allows:
- Easy extension for new block types
- Clear separation of concerns
- Simple addition of new language features without modifying core parser logic

## Other Related ADRs

- [Indentation and Block Parenting](000009-indentation-block-parenting.md) - Defines hierarchical structure rules
- [Sections and Navigation](000010-sections-and-navigation.md) - First major extension using the block parser system

