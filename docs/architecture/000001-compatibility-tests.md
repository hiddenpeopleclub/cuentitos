# Compatibility Tests

### Submitters

- Fran Tufro (Hidden People Club)

## Change Log

- 2023-12-24 - [Updated CLI requirements](https://github.com/hiddenpeopleclub/cuentitos/pull/51)
- 2023-12-21 - [First draft of ADR created](https://github.com/hiddenpeopleclub/cuentitos/pull/51).
- 2024-12-17 - [Language corrections](https://github.com/hiddenpeopleclub/cuentitos/pull/52).

## Use Case(s)

To ensure a healthy ecosystem around the `cuentitos` programming language, we
need to confirm that all runtimes are compatible with each other.

To achieve this, I will create a suite of tests that can be run against
command-line implementations of the runtime with very specific input support.

## Context

We need to guarantee that all runtimes are compatible so that any script written
in `cuentitos` can run seamlessly in any runtime.

This ADR will document the work required to create compatibility tests and a
test runner.

This will also help us to ensure that new features do not break existing
functionality and allow us fix any issues that arise by creating examples that
can be run against the runtimes.

## Proposed Design

This ADR proposes the following:

1. **Test Case Format**
2. **Test Runner**
3. **CLI Requirements**
4. **Documentation**

These four components will enable us to establish a reliable protocol for
validating runtime compatibility.

### Test Case Format

Each test will be defined in a Markdown-like file with the following structure:

````markdown
# Test Name

A description of the test, that may include any indication regarding the
syntax to be used, or anything that might be useful to the user.

## Script
```cuentitos
// The script to run
```

## Input
```input
// A line or comma separated list of inputs
```

## Result
```result
// The expected command-line output
```
````

### Test Case Runner

I will develop a tool to execute test cases and generate a report.

This tool will be created in the `compat` directory and named
`cuentitos-compat`.

To run all tests, you will use:

```bash
./cuentitos-compat [runtime_cli] [test_case_glob]
```

`runtime_cli` is the path to the runtime executable, and `test_case_glob` is a
glob pattern to match the test files:

```bash
./cuentitos-compat ./cuentitos-cpp compatibility-tests/**/*.md
```

To run a specific test case:

```bash
./cuentitos-compat [runtime_cli] [test_case_file_path]
```

The test runner will compare the output generated by the runtime CLI with the
expected result specified in the test file.

If a script contains errors, the runner will verify the output against the
**Result** section in the test case. The test will fail if the outputs do not
match.

To skip failing tests for scripts with errors, you can use the `--ignore-errors`
flag:

```bash
./cuentitos-compat [runtime_cli] [test_case_glob] --ignore-errors
```

This option will exclude error-producing test cases from the final report.

### CLI Requirements

The runtime CLI must support the following parameters:

```bash
./runtime-cli run [script_file_path] --input [input_string]
```

- `script_file_path`: The path to the script file.
- `input_string`: A comma-separated list of inputs to be used by the script.

- Return **0** when the script executes successfully.
- Return **1** when the script fails.
- Print all output to the standard output, so it can be captured by the test
runner.

### Documentation

I will create a document explaining how to create new tests, including details
on defining input and expected output.
